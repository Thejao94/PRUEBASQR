<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Registro QR Offline</title>
  <script src="html5-qrcode.min.js"></script>
  <link rel="manifest" href="manifest.json">
  <style>
    body, html {
      margin: 0;
      padding: 0;
      width: 50%;
      height: 50%;
      overflow: hidden;
      background: #000;
      color: #fff;
      font-family: sans-serif;
      text-align: center;
    }
    #reader {
      width: 100vw;
      height: 100vh;
    }
  </style>
</head>
<body>
  <h2 style="position:absolute;top:10px;left:50%;transform:translateX(-50%);z-index:10;color:white;">
    Escanea tu c√≥digo
  </h2>
  <div id="reader"></div>

  <script>
    const token = "8319147777:AAHbKbbkNF4KHvl1q4MwRDf-7BURIy20taY";        // ‚ö†Ô∏è Reemplazar
    const chat_id = "-4839758866";         // ‚ö†Ô∏è Reemplazar con ID del grupo

    function guardarOffline(mensaje) {
      let cola = JSON.parse(localStorage.getItem("colaMensajes")) || [];
      cola.push(mensaje);
      localStorage.setItem("colaMensajes", JSON.stringify(cola));
      console.log("Guardado offline:", mensaje);
    }

    function enviarTelegram(mensaje) {
      const url = `https://api.telegram.org/bot${token}/sendMessage`;
      return fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ chat_id, text: mensaje })
      });
    }

    async function procesarCola() {
      let cola = JSON.parse(localStorage.getItem("colaMensajes")) || [];
      if (cola.length === 0) return;

      let pendientes = [];
      for (let msg of cola) {
        try {
          let res = await enviarTelegram(msg);
          if (!res.ok) throw new Error("Error env√≠o");
          console.log("Enviado:", msg);
        } catch (e) {
          pendientes.push(msg);
        }
      }
      localStorage.setItem("colaMensajes", JSON.stringify(pendientes));
    }

    function registrar(nombreQR) {
      navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        const fecha = new Date().toLocaleDateString();
        const hora = new Date().toLocaleTimeString();

        const mensaje = `üìç Registro:
Nombre: ${nombreQR}
Fecha: ${fecha}
Hora: ${hora}
Ubicaci√≥n: https://maps.google.com/?q=${lat},${lon}`;

        guardarOffline(mensaje);
        procesarCola();
        alert("Registro guardado ‚úÖ (se enviar√° cuando haya internet)");
      }, err => {
        const fecha = new Date().toLocaleDateString();
        const hora = new Date().toLocaleTimeString();
        const mensaje = `üìç Registro (sin GPS):
Nombre: ${nombreQR}
Fecha: ${fecha}
Hora: ${hora}`;
        guardarOffline(mensaje);
        procesarCola();
        alert("Registro guardado sin GPS ‚ùå");
      });
    }

    let html5QrCode = new Html5Qrcode("reader");

    function onScanSuccess(decodedText, decodedResult) {
      html5QrCode.stop().then(() => {
        registrar(decodedText);
        // Reinicia despu√©s de 3 segundos para evitar duplicados
        setTimeout(() => {
          html5QrCode.start(
            { facingMode: "environment" },
            { fps: 10, qrbox: { width: window.innerWidth * 0.8, height: window.innerWidth * 0.8 } },
            onScanSuccess
          );
        }, 5000);
      });
    }

    html5QrCode.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: { width: window.innerWidth * 0.8, height: window.innerWidth * 0.8 } },
      onScanSuccess
    );

    window.addEventListener("online", procesarCola);

    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("sw.js");
    }
  </script>
</body>
</html>
