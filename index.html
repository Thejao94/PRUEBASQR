<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Registro QR Offline</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <link rel="manifest" href="manifest.json">
</head>
<body>
  <h2>Esc√°ner QR (Offline/Online)</h2>
  <div id="reader" style="width:300px;"></div>

  <script>
    const token = "8319147777:AAHbKbbkNF4KHvl1q4MwRDf-7BURIy20taY";        // ‚Üê Reemplaza
    const chat_id = "-4839758866";         // ‚Üê Reemplaza con ID del grupo

    // --- Guardar en cola offline ---
    function guardarOffline(mensaje) {
      let cola = JSON.parse(localStorage.getItem("colaMensajes")) || [];
      cola.push(mensaje);
      localStorage.setItem("colaMensajes", JSON.stringify(cola));
      console.log("Guardado offline:", mensaje);
    }

    // --- Intentar enviar a Telegram ---
    function enviarTelegram(mensaje) {
      const url = `https://api.telegram.org/bot${token}/sendMessage`;

      return fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ chat_id, text: mensaje })
      });
    }

    // --- Procesar cola ---
    async function procesarCola() {
      let cola = JSON.parse(localStorage.getItem("colaMensajes")) || [];
      if (cola.length === 0) return;

      let pendientes = [];
      for (let msg of cola) {
        try {
          let res = await enviarTelegram(msg);
          if (!res.ok) throw new Error("Error env√≠o");
          console.log("Enviado:", msg);
        } catch (e) {
          pendientes.push(msg); // si falla, se queda en cola
        }
      }
      localStorage.setItem("colaMensajes", JSON.stringify(pendientes));
    }

    // --- Registrar un QR ---
    function registrar(nombreQR) {
      navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        const fecha = new Date().toLocaleDateString();
        const hora = new Date().toLocaleTimeString();

        const mensaje = `üìç Registro:
Nombre: ${nombreQR}
Fecha: ${fecha}
Hora: ${hora}
Ubicaci√≥n: https://maps.google.com/?q=${lat},${lon}`;

        guardarOffline(mensaje);
        procesarCola(); // intenta enviar si hay se√±al
        alert("Registro guardado ‚úÖ (se enviar√° cuando haya internet)");
      });
    }

    // --- Esc√°ner QR ---
    function onScanSuccess(decodedText, decodedResult) {
      registrar(decodedText);
    }

    const html5QrCode = new Html5Qrcode("reader");
    html5QrCode.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250 },
      onScanSuccess
    );

    // --- Detectar cuando vuelve el internet ---
    window.addEventListener("online", procesarCola);

    // --- Registrar service worker ---
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("sw.js");
    }
  </script>
</body>
</html>
